<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>手写Promise</title>
</head>

<body>
  <script>
    const PENDING = 'PENDING'
    const FULFILLED = 'FULFILLED'
    const REJECTED = 'REJECTED'
    const promiseResolveExcute = (promise2, x, resolve, reject) => {
      if (x === promise2) {
        throw new Error("promise 循环引用")
      }
      if (x instanceof MyPromise) {
        if (x.state === PENDING) {
          // ??????????????
          x.then(y => {
            promiseResolveExcute(promise2, y, resolve, reject)
          }, reject)
        }
        x.state === FULFILLED && resolve(x)
        x.state === REJECTED && reject(x)
      }
      if ((typeof x === 'function' || typeof x === "object") && typeof x != null && x.then) {
        if (typeof x.then === 'function') {
          x.then(y => {
            resolve(y)
          }, err => {
            reject(err)
          })
        } else {
          resolve(x)
        }
      } else {
        resolve(x)
      }
    }
    class MyPromise {
      static race(promises) {
        return new MyPromise((resolve, reject) => {
          for (let i = 0; i < promises.length; i++) {
            promises[i].then(data => {
              resolve(data)
            }, err => {
              reject(err)
            })
          }
        })
      }
      static resolve(val) {
        return new MyPromise((resolve, reject) => {
          if (val instanceof MyPromise) return resolve(val)
          if ((typeof val === "function" || typeof val === "object") && val !== null && val.then) {
            if (typeof x.then === 'function') {
              val.then(y => {
                resolve(y)
              }, err => {
                reject(err)
              })
            }
          }
          resolve(val)
        })
      }

      finally(callback) {
        return this.then(callback()).then(data => data, val => val)
      }
      static all(promises) {
        return new MyPromise((resolve, reject) => {
          let result = []
          let index = 0

          function processResult(i, data) {
            result[i] = data;
            index++;
            if (index === result.length) {
              resolve(result);
            }
          }
          for (let i = 0; i < promises.length; i++) {
            promises[i].then(data => {
              processResult(i, data);
            }, err => {
              reject(err)
            })
          }
        })
      }
      constructor(fn) {
        this.state = PENDING
        this.value = null
        this.resolveCallbacks = []
        this.rejectCallbacks = []
        const resolve = (val) => {
          if ((typeof val === "object" || typeof val === "function") && val !== null && val.then) {
            promiseResolveExcute(this, val, resolve, reject)
            return
          }
          setTimeout(() => {
            if (this.state === PENDING) {
              this.state = FULFILLED
              this.value = val
              this.resolveCallbacks.map(fn => fn())
            }
          }, 1000);
        }
        const reject = (val) => {
          if ((typeof val === "object" || typeof val === "function") && val !== null && val.then) {
            promiseResolveExcute(this, val, resolve, reject)
            return
          }
          setTimeout(() => {
            if (this.state === PENDING) {
              this.state = REJECTED
              this.value = val
              this.rejectCallbacks.map(fn => fn())
            }
          }, 1000);
        }
        fn(resolve, reject)
      }
      then(onFulfilled = val => val, onRejected = err => {
        throw new Error(err)
      }) {
        let promise2 = null
        if (this.state === FULFILLED) {
          promise2 = new MyPromise((resolve, reject) => {
            this.resolveCallbacks.push(() => {
              const x = onFulfilled(this.value)
              promiseResolveExcute(promise2, x, resolve, reject)
            })
          })
        }
        if (this.state === REJECTED) {
          promise2 = new MyPromise((resolve, reject) => {
            this.rejectCallbacks.push(() => {
              const x = onRejected(this.value)
              promiseResolveExcute(promise2, x, resolve, reject)
            })
          })
        }
        if (this.state === PENDING) {
          promise2 = new MyPromise((resolve, reject) => {
            this.resolveCallbacks.push(() => {
              const x = onFulfilled(this.value)
              promiseResolveExcute(promise2, x, resolve, reject)
            })
            this.rejectCallbacks.push(() => {
              const x = onRejected(this.value)
              promiseResolveExcute(promise2, x, resolve, reject)
            })
          })
        }
        return promise2
      }
      catch (err) {
        return new MyPromise((resolve, reject) => {
          reject(err)
        })
      }

    }
  </script>
  <script>
    // 步骤1
    // const promise = new MyPromise((resolve, reject) => {
    //   setTimeout(() => {
    //     // ajax 获取数据
    //     resolve("step1");
    //   }, 1000);
    // }).then(data => {
    //   console.log("获取到数据：", data);
    // });

    // 步骤2
    // const promise = new MyPromise((resolve, reject) => {
    //   resolve("step2");
    // }).then(data => {
    //   console.log("获取到数据：", data);
    // });

    // 步骤3
    // const promise = new MyPromise((resolve, reject) => {
    //   resolve("step3");
    //   resolve("step3.1");
    // }).then(data => {
    //   console.log("获取到数据：", data);
    // });

    // 步骤4
    // const promise = new MyPromise((resolve, reject) => {
    //     resolve("step4");
    //   })
    //   .then(data => {
    //     console.log("获取到数据：", data);
    //     return "step4.1";
    //   })
    //   .then(data => {
    //     console.log("获取到数据：", data);
    //   });

    // 步骤5
    // const promise = new MyPromise((resolve, reject) => {
    //     resolve("step5");
    //   })
    //   .then(data => {
    //     console.log("获取到数据：", data);
    //     return "step5.1";
    //   })
    //   .then()
    //   .then(data => {
    //     console.log("获取到数据：", data);
    //   });

    // 步骤6
    // const promise = new MyPromise((resolve, reject) => {
    //     resolve("step6");
    //   })
    //   .then(data => {
    //     console.log("获取到数据：", data);
    //     return {
    //       then(r, j) {
    //         r("step6.1");
    //       }
    //     };
    //   })
    //   .then(data => {
    //     console.log("获取到数据：", data);
    //   });

    // 步骤7
    // const promise = new MyPromise((resolve, reject) => {
    //     resolve("step7");
    //   })
    //   .then(data => {
    //     console.log("获取到数据：", data);
    //     return new MyPromise(resolve => {
    //       resolve("7.1");
    //     });
    //   })
    //   .then(data => {
    //     console.log("获取到数据：", data);
    //   });

    // 步骤8
    // const promise = new MyPromise((resolve, reject) => {
    //   resolve(
    //     new Promise(resolve => {
    //       resolve("step8");
    //     })
    //   );
    // }).then(data => {
    //   console.log("获取到数据：", data);
    // });

    // step9
    // const promise = new MyPromise((resolve, reject) => {
    //   resolve("step9");
    // });
    // const promise1 = promise.then(data => {
    //   return promise1;
    // });

    // step10
    // MyPromise.race([
    //   new MyPromise((resolve, reject) => {
    //     reject(3)
    //   }),
    //   new MyPromise(resolve => {
    //     resolve(1);
    //   }),
    //   new MyPromise(resolve => {
    //     resolve(2);
    //   }),
    // ]).then(dataList => {
    //   console.log(dataList);
    // });

    // step11
    //   const promise = new MyPromise((resolve, reject) => {
    //     reject("step11");
    //   }).then(
    //     data => {
    //       console.log("resolve 值：", data);
    //     },
    //     rej => {
    //       console.log("reject 值：", rej);
    //     }
    //   );

    // step12
    // const promise = new MyPromise((resolve, reject) => {
    //   resolve("step12");
    // });

    // setTimeout(() => {
    //   promise.then(data => {
    //     console.log("step12:", data);
    //   });

    //   promise.then(data => {
    //     console.log("step12:", data);
    //   });
    // }, 1000);

    // step13
    // MyPromise.race([
    //   new MyPromise((resolve, reject) => {
    //     setTimeout(() => {

    //       reject(1)
    //     }, 1000)
    //   }),
    //   new MyPromise(resolve => {
    //     setTimeout(() => {

    //       resolve(1);
    //     }, 2000);
    //   }),
    //   new MyPromise(resolve => {
    //     setTimeout(() => {

    //       resolve(2);
    //     }, 2000);
    //   }),
    // ]).then(dataList => {
    //   console.log(dataList);
    // });

    // const promise = new MyPromise((resolve, reject) => {
    //   reject("step11");
    // }).finally(() => {
    //   console.log(1111111111111)
    // })
  </script>
</body>

</html>