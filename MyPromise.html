<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>手写Promise</title>
</head>

<body>
  <script>
    const PENDING = 'PENDING'
    const FULFILLED = 'FULFILLED'
    const REJECTED = 'REJECTED'
    const promiseResolveExcute = (promise2, x, resolve, reject) => {
      if (x === promise2) {
        throw new Error("promise 循环引用")
      }
      if (x instanceof MyPromise) {
        if (x.state === PENDING) {
          // ??????????????
          x.then(y => {
            promiseResolveExcute(promise2, y, resolve, reject)
          }, reject)
        }
        x.state === FULFILLED && resolve(x)
        x.state === REJECTED && reject(x)
      }
      if ((typeof x === 'function' || typeof x === "object") && typeof x != null && x.then) {
        if (typeof x.then === 'function') {
          x.then(y => {
            resolve(y)
          }, err => {
            reject(err)
          })
        } else {
          resolve(x)
        }
      } else {
        resolve(x)
      }
    }
    class MyPromise {

      finally(callback) {
        let p = this.constructor
        return this.then(
          value => p.resolve(callback()).then(() => value),
          err => p.resolve(callback()).then(() => {
            throw err
          })
        )
      }
      static race(promises) {
        return new MyPromise((resolve, reject) => {
          for (let i = 0; i < promises.length; i++) {
            promises[i].then(val => {
              resolve(val)
            }, err => {
              reject(err)
            })
          }
        })
      }
      static resolve(val) {
        return new MyPromise((resolve, reject) => {
          if (val == null) resolve(null)
          if (val instanceof MyPromise) {
            val.then(y => {
              resolveExcutor(this, y, resolve, reject)
            }, err => {
              reject(err)
            })
          }
          resolve(val)
        })
      }
      static all(promises) {
        return new MyPromise((resolve, reject) => {
          let result = []
          let index = 0
          for (let i = 0; i < promises.length; i++) {
            promises[i].then(y => {
              result[i] = y
              index++
              if (index === promises.length) {
                resolve(result)
              }
            }, err => {
              reject(err)
            })
          }
        })
      }
      constructor(fn) {
        this.state = PENDING
        this.value = undefined;
        this.resolveCallbacks = []
        this.rejectCallbacks = []
        const resolve = (val) => {
          setTimeout(() => {
            if ((typeof val === "function" || typeof val === "object") && val !== null && typeof val.then ===
              "function") {
              resolveExcutor(this, val, resolve, reject)
              return
            }
            if (this.state === PENDING) {
              this.state = FULFILLED
              this.value = val
              this.resolveCallbacks.map(fn => fn(val))
            }
          }, 1000)
        }
        const reject = (val) => {
          setTimeout(() => {
            if ((typeof val === "function" || typeof val === "object") && val !== null && typeof val
              .then === "function") {
              resolveExcutor(this, val, resolve, reject)
              return
            }
            if (this.state === PENDING) {
              this.state = REJECTED
              this.value = val
              this.rejectCallbacks.map(fn => fn())
            }
          }, 1000)
        }
        fn(resolve, reject)
      }
      then(onFulfilled = val => val, onRejected = err => {
        throw err
      }) {
        let promise2 = null
        if (this.state === PENDING) {
          promise2 = new MyPromise((resolve, reject) => {
            this.resolveCallbacks.push(() => {
              const x = onFulfilled(this.value)
              resolveExcutor(promise2, x, resolve, reject)
            })
            this.rejectCallbacks.push(() => {
              const x = onRejected(this.value)
              resolveExcutor(promise2, x, resolve, reject)
            })
          })
        }
        if (this.state === FULFILLED) {
          promise2 = new MyPromise((resolve, reject) => {
            this.resolveCallbacks.push(() => {
              const x = onFulfilled(this.value)
              resolveExcutor(promise2, x, resolve, reject)
            })
          })
        }
        if (this.state === REJECTED) {
          promise2 = new MyPromise((resolve, reject) => {
            this.rejectCallbacks.push(() => {
              const x = onRejected(this.value)
              resolveExcutor(promise2, x, resolve, reject)
            })
          })
        }
        return promise2
      }
      catch (err) {
        return new MyPromise((resolve, reject) => {
          reject(err)
        })
      }
    }

    function resolveExcutor(promise2, x, resolve, reject) {
      if (x === promise2) {
        throw new Error("循环调用promise")
      }
      if (x instanceof MyPromise) {
        if (x.state === PENDING) {
          x.then(y => {
            resolveExcutor(promise2, y, resolve, reject)
          })
        }
        x.state === FULFILLED && resolve(x)
        x.state === REJECTED && reject(x)
      }
      if ((typeof x === "function" || typeof x === "object") && typeof x !== null) {
        if (typeof x.then === "function") {
          x.then(y => {
            resolve(y)
          }, err => {
            reject(err)
          })
        } else {
          resolve(x)
        }
      } else {
        resolve(x)
      }
    }
  </script>
  <script>
    // 步骤1
    //   const promise = new MyPromise((resolve, reject) => {
    //     setTimeout(() => {
    //       // ajax 获取数据
    //       resolve("step1");
    //     }, 1000);
    //   }).then(data => {
    //     console.log("获取到数据：", data);
    //   });

    // 步骤2
    // const promise = new MyPromise((resolve, reject) => {
    //   resolve("step2");
    // }).then(data => {
    //   console.log("获取到数据：", data);
    // });

    // 步骤3
    // const promise = new MyPromise((resolve, reject) => {
    //   resolve("step3");
    //   resolve("step3.1");
    // }).then(data => {
    //   console.log("获取到数据：", data);
    // });

    // 步骤4
    // const promise = new MyPromise((resolve, reject) => {
    //     resolve("step4");
    //   })
    //   .then(data => {
    //     console.log("获取到数据：", data);
    //     return "step4.1";
    //   })
    //   .then(data => {
    //     console.log("获取到数据：", data);
    //   });

    // 步骤5
    // const promise = new MyPromise((resolve, reject) => {
    //     resolve("step5");
    //   })
    //   .then(data => {
    //     console.log("获取到数据：", data);
    //     return "step5.1";
    //   })
    //   .then()
    //   .then(data => {
    //     console.log("获取到数据：", data);
    //   });

    // 步骤6
    // const promise = new MyPromise((resolve, reject) => {
    //     resolve("step6");
    //   })
    //   .then(data => {
    //     console.log("获取到数据：", data);
    //     return {
    //       then(r, j) {
    //         r("step6.1");
    //       }
    //     };
    //   })
    //   .then(data => {
    //     console.log("获取到数据：", data);
    //   });

    // 步骤7
    // const promise = new MyPromise((resolve, reject) => {
    //     resolve("step7");
    //   })
    //   .then(data => {
    //     console.log("获取到数据：", data);
    //     return new MyPromise(resolve => {
    //       resolve("7.1");
    //     });
    //   })
    //   .then(data => {
    //     console.log("获取到数据：", data);
    //   });

    // 步骤8
    // const promise = new MyPromise((resolve, reject) => {
    //   resolve(
    //     new Promise(resolve => {
    //       resolve("step8");
    //     })
    //   );
    // }).then(data => {
    //   console.log("获取到数据：", data);
    // });

    // step9
    // const promise = new MyPromise((resolve, reject) => {
    //   resolve("step9");
    // });
    // const promise1 = promise.then(data => {
    //   return promise1;
    // });

    // step10
    // MyPromise.race([
    //   new MyPromise((resolve, reject) => {
    //     reject(3)
    //   }),
    //   new MyPromise(resolve => {
    //     resolve(1);
    //   }),
    //   new MyPromise(resolve => {
    //     resolve(2);
    //   }),
    // ]).then(dataList => {
    //   console.log(dataList);
    // });

    // step11
    //   const promise = new MyPromise((resolve, reject) => {
    //     reject("step11");
    //   }).then(
    //     data => {
    //       console.log("resolve 值：", data);
    //     },
    //     rej => {
    //       console.log("reject 值：", rej);
    //     }
    //   );

    // step12
    const promise = new MyPromise((resolve, reject) => {
      resolve("step12");
    });

    setTimeout(() => {
      promise.then(data => {
        console.log("step12:", data);
      });

      promise.then(data => {
        console.log("step12:", data);
      });
    }, 1000);

    // finally
    const promise = new MyPromise((resolve, reject) => {
      reject("step11");
    })
    promise.then(
        data => {
          console.log("resolve 值：", data);
          return 'resolve'
        },
        rej => {
          console.log("reject 值：", rej);
          return "reject"
        }
      )
      .finally(() => {
        console.log(2222222222)
        return 1111111
      })
      .then((data) => {
        console.log("data", data)
        return 3333333333
        // throw new Error("finnally")
      }).then(val => {
        console.log("val", val)

      })
  </script>
</body>

</html>